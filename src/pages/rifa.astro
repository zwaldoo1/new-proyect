---
import BaseLayout from '../layouts/BaseLayout.astro';
import Footer from '../components/Footer.astro';
---

<BaseLayout>
  <!-- Contenedor de página: altura completa + layout en columna -->
  <div class="min-h-dvh flex flex-col"> <!-- <- cambia min-h-screen por min-h-dvh si puedes -->
    <!-- MAIN crece para ocupar el espacio disponible -->
    <main class="bg-animated flex-1 p-4 text-white flex flex-col items-center">
      <h1 class="text-4xl font-bold mb-6">Elige tu número de la rifa</h1>
      <p class="mb-4 max-w-xl text-center">
        Haz clic en un número para comprarlo. Los números ya comprados aparecerán en rojo y deshabilitados.
      </p>

      <div
        id="rifa-grid"
        class="grid grid-cols-10 gap-1 max-h-[500px] overflow-y-auto bg-white p-2 rounded shadow text-xs text-center text-black w-full max-w-4xl"
      >
        <!-- Los botones se insertan con JS -->
      </div>

      <button id="load-more" class="mt-4 px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700">
        Mostrar más números
      </button>
    </main>

    <!-- Footer pegado abajo -->
    <footer class="mt-auto">
      <Footer/>
    </footer>
  </div>

  <script type="module" is:inline>
    import { initializeApp } from 'https://www.gstatic.com/firebasejs/9.22.2/firebase-app.js';
    import { getFirestore, collection, onSnapshot, addDoc } from 'https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore.js';

    const firebaseConfig = {
      apiKey: "AIzaSyDrn2-siV9XZxms0caGwz6kA1bCM4i5kgM",
      authDomain: "campeonato-v1.firebaseapp.com",
      projectId: "campeonato-v1",
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    const TOTAL_NUMEROS = 10000;
    const PAGE_SIZE = 100;

    document.addEventListener("DOMContentLoaded", () => {
      const grid = document.getElementById("rifa-grid");
      const loadMoreBtn = document.getElementById("load-more");

      const reservedNumbers = new Set();
      let currentMax = PAGE_SIZE;

      function renderInitialButtons() {
        grid.textContent = "";
        for (let i = 1; i <= currentMax && i <= TOTAL_NUMEROS; i++) {
          const btn = document.createElement("button");
          btn.textContent = i;
          btn.className = "py-1 rounded bg-green-500 hover:bg-green-700 text-white";
          btn.disabled = false;
          btn.addEventListener("click", () => handleSelect(i));
          grid.appendChild(btn);
        }
      }

      function renderButtons() {
        grid.textContent = "";
        for (let i = 1; i <= currentMax && i <= TOTAL_NUMEROS; i++) {
          const taken = reservedNumbers.has(i.toString());
          const btn = document.createElement("button");
          btn.textContent = i;
          btn.className = taken
            ? "py-1 rounded bg-red-500 text-white cursor-not-allowed"
            : "py-1 rounded bg-green-500 hover:bg-green-700 text-white";
          btn.disabled = taken;
          btn.addEventListener("click", () => handleSelect(i));
          grid.appendChild(btn);
        }
        loadMoreBtn.style.display = currentMax >= TOTAL_NUMEROS ? "none" : "block";
      }

      async function handleSelect(num) {
        if (reservedNumbers.has(num.toString())) return;
        const confirmed = confirm("¿Quieres comprar el número " + num + "?");
        if (!confirmed) return;

        try {
          await addDoc(collection(db, "numerosReservados"), { numero: num });
          alert(`Número ${num} reservado con éxito.`);
        } catch (error) {
          alert('Error al reservar: ' + error.message);
        }
      }

      loadMoreBtn.addEventListener("click", () => {
        currentMax = Math.min(currentMax + PAGE_SIZE, TOTAL_NUMEROS);
        renderButtons();
      });

      // Render inicial
      renderInitialButtons();

      // Escuchar en tiempo real y refrescar UI
      onSnapshot(collection(db, "numerosReservados"), (snapshot) => {
        reservedNumbers.clear();
        snapshot.forEach((doc) => {
          reservedNumbers.add(doc.data().numero.toString());
        });
        renderButtons();
      });
    });
  </script>
</BaseLayout>
